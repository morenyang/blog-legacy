---
title: 字体渲染的一些Share
tags:
---

_前段时间回家和 [ewind](http://ewind.us/) 大神吹了吹水。交谈过程中了解到他最近在研究使用 JavaScript 渲染文字黑科技，发现在计算机中根据字体渲染文字也是一门有趣的学问。于是我也去了解了一些跟字体渲染有关的内容。_

## 计算机字体标准的历史

在上古时期的计算机中，字体都是使用点阵 (bitmap) 的方式来描述的。点阵字体描述了每一个文字的各个字号下像素点的排列组合方式。
但是它存在一些无法避免的问题。例如，你需要的字号没有被描述，那么系统只能根据相近的被描述的字号推算出应有的点阵排列，这会使文字看起来相当丑陋；或者是当你需要把文字旋转到一个微妙的角度时，很可能它的显示效果也会不尽人意。

在 1980 年代后期，Adobe 推出了矢量字体标准`Type1`，使用适量的图形来描述字母。矢量字体在放大缩小的时候不会遇到像点阵字体那样失真的问题。同时，Adobe 还推出了用于印刷的语言`Postscript`。

当时 MS 和 Apple 都想在自己的操作系统中引入矢量字体，但是因为 Adobe 的东西太贵了，因此这两家公司联手开发了自己的矢量字体和打印技术。但是最终落地的只有 Apple 开发的`TrueType`，而 Microsoft 开发的打印引擎`TrueImage`只是放了个鸽子。

![bitmap_font_and_true_type_font](/blog/images/190102/1.gif)

![microsoft_true_type](/blog/images/190102/scale.gif)

到了后面 Adobe 发现自己的游戏玩不下去了，于是也和微软一起，开发了`OpenType`字体标准，也叫`Type2`，OpenType 兼容 TrueType 标准（也可以看做是 TrueType 的升级版），但有一些更强大的功能。

除此之外，还有为 web 而生的字体标准`woff`和`woff2`，它们的优势在于压缩率高。当然这些都是后话了。

由于 TrueType 是计算机行业中比较基础、应用广泛的字体格式，因此本文的字体介绍中都使用 TrueType 来举例。

## 如何描述一个字母

在矢量字体中，描述一个字母方式由原本的点阵变成了使用数学符号记录的字母的轮廓。

在 TrueType 中，使用直线和曲线的组合以构建复杂的字形。

### 标记点

实际上在最底层，TrueType 字体中的每一个文字都是由网格上的点来描述的。

通过两个点可以得到一条直线。通过三个点可以得到一个二次贝塞尔曲线 (Bezier quadratic curves)。在这种情况下，有两个点作为曲线的起点和终点，另一个点为在曲线外的控制点。这三个点可以确定一条唯一的曲线。
它的完整定义如下：

> 给定三个点 p0，p1，p2。控制点 p1 位于点 p0 和 p2 处的切线与曲线的交点处。
> 因此，p0，p1 与点 p0 处的曲线相切。
> 类似地，p2，p1 与点 p2 处的曲线相切。
> 由这三个点指定的曲线由参数方程定义。
> 对于从 0 到 1 的 t，p(t)的位置如下所示：
> <center>      p(t) = (1-t)<sup>2</sup><cite>p<sub>0</sub></cite> + 2t(1-t)<cite>p<sub>1</sub></cite> + t<sup>2</sup><cite>p<sub>2</sub></cite></center>
由此可以得出这条曲线，如下图所示：

![figure_1](/blog/images/190102/fig01.jpg)

更复杂的曲线则可以使用多段二次曲线连接得到。两段曲线的切线相互连接，可以产生二次样条(quadratic spline)。
如果每个曲线上的点都位于连接其两侧的两个侧翼控制点的线上，则连接的二次曲线具有一阶连续性和切线连续性。

例如下图，由p0，p1，p2三个点定义了一条曲线，再添加一个曲线上的终点p4，并在p1p2延长线上添加控制点p3，这样就得到了由p2，p3，p4定义的一条新的曲线。这条曲线与第一条在p2处相连，并与第一条具有一阶连续性。

![figure_1](/blog/images/190102/fig02.jpg)

在这五个点中，由于p2是可以由p1，p3和其他数据推算出来的，因此可以去掉点p2来简化这条曲线的表述。